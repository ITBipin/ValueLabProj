using System;
using System.Collections.Generic;
using System.Linq;
using CodeChallenge.Models;
using CodeChallenge.Repositories;

namespace CodeChallenge.Logic
{
    public class MessageLogic : IMessageLogic
    {
        private readonly IMessageRepository _repo;

        public MessageLogic(IMessageRepository repo)
        {
            _repo = repo;
        }

        public IEnumerable<Message> GetAll(Guid organizationId) => _repo.GetAll(organizationId);

        public Message? GetById(Guid organizationId, Guid id) => _repo.Get(organizationId, id);

        public Result Create(Message message)
        {
            var errors = Validate(message, isNew: true);
            if (errors.Any()) return new ValidationErrorResult { Errors = errors };
            if (_repo.ExistsTitle(message.OrganizationId, message.Title))
                return new ConflictResult { Message = "Title must be unique per organization" };
            message.Id = Guid.NewGuid();
            message.CreatedAt = DateTime.UtcNow;
            _repo.Create(message);
            return new CreatedResult<Message> { Value = message };
        }

        public Result Update(Message message)
        {
            var existing = _repo.Get(message.OrganizationId, message.Id);
            if (existing == null) return new NotFoundResult();
            if (!existing.IsActive) return new ValidationErrorResult { Errors = new Dictionary<string, string[]> { { "IsActive", new[] { "Cannot update inactive message" } } } };
            var errors = Validate(message, isNew: false);
            if (errors.Any()) return new ValidationErrorResult { Errors = errors };
            if (_repo.ExistsTitle(message.OrganizationId, message.Title, message.Id))
                return new ConflictResult { Message = "Title must be unique per organization" };
            // preserve CreatedAt
            message.CreatedAt = existing.CreatedAt;
            message.UpdatedAt = DateTime.UtcNow;
            _repo.Update(message);
            return new SuccessResult();
        }

        public Result Delete(Guid organizationId, Guid id)
        {
            var existing = _repo.Get(organizationId, id);
            if (existing == null) return new NotFoundResult();
            if (!existing.IsActive) return new ValidationErrorResult { Errors = new Dictionary<string, string[]> { { "IsActive", new[] { "Cannot delete inactive message" } } } };
            var ok = _repo.Delete(organizationId, id);
            return ok ? new SuccessResult() : new NotFoundResult();
        }

        private Dictionary<string, string[]> Validate(Message message, bool isNew)
        {
            var errors = new Dictionary<string, string[]>();
            if (string.IsNullOrWhiteSpace(message.Title) || message.Title.Length < 3 || message.Title.Length > 200)
                errors["Title"] = new[] { "Title is required and must be between 3 and 200 characters" };
            if (string.IsNullOrWhiteSpace(message.Content) || message.Content.Length < 10 || message.Content.Length > 1000)
                errors["Content"] = new[] { "Content must be between 10 and 1000 characters" };
            return errors;
        }
    }
}
